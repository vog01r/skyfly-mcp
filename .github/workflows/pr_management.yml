name: ðŸ”„ Gestion Automatique des Pull Requests

on:
  schedule:
    # ExÃ©cution quotidienne Ã  9h UTC (10h Paris)
    - cron: '0 9 * * *'
  
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Mode simulation (ne fait que analyser)'
        required: false
        default: 'true'
        type: choice
        options:
        - 'true'
        - 'false'
      
      max_prs_threshold:
        description: 'Seuil maximum de PRs ouvertes avant action'
        required: false
        default: '5'
        type: string

jobs:
  pr_management:
    runs-on: ubuntu-latest
    name: ðŸ“Š Analyse et Gestion des PRs
    
    permissions:
      contents: read
      pull-requests: write
      issues: write
    
    steps:
    - name: ðŸ“¥ Checkout du repository
      uses: actions/checkout@v4
      
    - name: ðŸ Configuration Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: ðŸ”§ Installation des dÃ©pendances
      run: |
        python -m pip install --upgrade pip
        pip install requests python-dateutil
    
    - name: ðŸ“‹ Comptage des PRs ouvertes
      id: count_prs
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        PR_COUNT=$(gh pr list --state open --json number | jq length)
        echo "pr_count=$PR_COUNT" >> $GITHUB_OUTPUT
        echo "ðŸ“Š PRs ouvertes trouvÃ©es: $PR_COUNT"
        
        THRESHOLD=${{ github.event.inputs.max_prs_threshold || '5' }}
        echo "threshold=$THRESHOLD" >> $GITHUB_OUTPUT
        
        if [ "$PR_COUNT" -gt "$THRESHOLD" ]; then
          echo "needs_action=true" >> $GITHUB_OUTPUT
          echo "âš ï¸ Seuil dÃ©passÃ© ($PR_COUNT > $THRESHOLD) - Action requise"
        else
          echo "needs_action=false" >> $GITHUB_OUTPUT
          echo "âœ… Nombre de PRs acceptable ($PR_COUNT <= $THRESHOLD)"
        fi
    
    - name: ðŸŽ¯ ExÃ©cution de la gestion des PRs
      if: steps.count_prs.outputs.needs_action == 'true' || github.event_name == 'workflow_dispatch'
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        DRY_RUN_FLAG=""
        if [ "${{ github.event.inputs.dry_run || 'true' }}" = "true" ]; then
          DRY_RUN_FLAG="--dry-run"
          echo "ðŸ” Mode DRY-RUN activÃ©"
        else
          echo "ðŸš€ Mode EXECUTION activÃ©"
        fi
        
        python pr_management_solution.py $DRY_RUN_FLAG --output pr_management_report_$(date +%Y%m%d_%H%M%S).md
    
    - name: ðŸ“„ Upload du rapport
      if: steps.count_prs.outputs.needs_action == 'true' || github.event_name == 'workflow_dispatch'
      uses: actions/upload-artifact@v4
      with:
        name: pr-management-report-${{ github.run_number }}
        path: pr_management_report_*.md
        retention-days: 30
    
    - name: ðŸ’¬ Commentaire de rÃ©sumÃ©
      if: steps.count_prs.outputs.needs_action == 'true' && github.event.inputs.dry_run != 'true'
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # CrÃ©er un issue de suivi si nÃ©cessaire
        ISSUE_TITLE="ðŸ”„ Rapport de gestion automatique des PRs - $(date +%Y-%m-%d)"
        ISSUE_BODY="## ðŸ“Š RÃ©sumÃ© de la gestion automatique des PRs
        
        **Date d'exÃ©cution:** $(date)
        **PRs ouvertes:** ${{ steps.count_prs.outputs.pr_count }}
        **Seuil configurÃ©:** ${{ steps.count_prs.outputs.threshold }}
        
        ### Actions automatiques exÃ©cutÃ©es:
        - Analyse de toutes les PRs ouvertes
        - Application des rÃ¨gles de gestion automatique
        - GÃ©nÃ©ration du rapport dÃ©taillÃ©
        
        ### Fichiers gÃ©nÃ©rÃ©s:
        - Rapport dÃ©taillÃ© disponible dans les artifacts
        
        ### Prochaines Ã©tapes:
        1. VÃ©rifier les actions automatiques
        2. Reviewer les PRs marquÃ©es comme prioritaires
        3. Valider les fermetures automatiques
        
        ---
        *GÃ©nÃ©rÃ© automatiquement par le workflow de gestion des PRs*"
        
        gh issue create --title "$ISSUE_TITLE" --body "$ISSUE_BODY" --label "automation,pr-management"

  # Job pour fermer automatiquement les PRs draft anciennes
  cleanup_old_drafts:
    runs-on: ubuntu-latest
    name: ðŸ§¹ Nettoyage des PRs draft anciennes
    
    permissions:
      contents: read
      pull-requests: write
    
    steps:
    - name: ðŸ“¥ Checkout du repository
      uses: actions/checkout@v4
    
    - name: ðŸ§¹ Fermeture des PRs draft anciennes
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "ðŸ” Recherche des PRs draft anciennes (>30 jours)..."
        
        # Date limite (30 jours)
        CUTOFF_DATE=$(date -d '30 days ago' --iso-8601)
        
        # RÃ©cupÃ©rer les PRs draft anciennes
        OLD_DRAFTS=$(gh pr list --state open --draft --json number,title,createdAt --jq ".[] | select(.createdAt < \"$CUTOFF_DATE\") | .number")
        
        if [ -z "$OLD_DRAFTS" ]; then
          echo "âœ… Aucune PR draft ancienne trouvÃ©e"
          exit 0
        fi
        
        echo "ðŸ“‹ PRs draft anciennes trouvÃ©es:"
        for pr_num in $OLD_DRAFTS; do
          PR_INFO=$(gh pr view $pr_num --json title,createdAt)
          echo "  - PR #$pr_num: $(echo $PR_INFO | jq -r .title)"
          
          # Fermer avec un commentaire explicatif
          gh pr close $pr_num --comment "ðŸ§¹ Fermeture automatique: PR draft inactive depuis plus de 30 jours.

Si cette PR est toujours pertinente, vous pouvez:
1. La rouvrir
2. La convertir en PR ready pour review
3. CrÃ©er une nouvelle PR avec le contenu mis Ã  jour

Cette action fait partie de la gestion automatique des PRs (SKYFLY-4)."
          
          echo "âŒ FermÃ©e: PR #$pr_num"
        done

  # Job pour activer l'auto-merge sur les PRs Ã©ligibles
  enable_automerge:
    runs-on: ubuntu-latest
    name: ðŸ¤– Activation Auto-merge
    
    permissions:
      contents: read
      pull-requests: write
    
    steps:
    - name: ðŸ“¥ Checkout du repository
      uses: actions/checkout@v4
    
    - name: ðŸ¤– Activation auto-merge pour PRs Ã©ligibles
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "ðŸ” Recherche des PRs Ã©ligibles pour auto-merge..."
        
        # CritÃ¨res pour auto-merge:
        # - PR ready (non-draft)
        # - Mergeable
        # - Petite taille (< 10 fichiers modifiÃ©s)
        # - Pas de conflits
        # - Mots-clÃ©s spÃ©cifiques (docs, fix, chore)
        
        ELIGIBLE_PRS=$(gh pr list --state open --json number,title,isDraft,mergeable,files --jq '
          .[] | 
          select(.isDraft == false) |
          select(.mergeable == "MERGEABLE") |
          select((.files | length) < 10) |
          select(.title | test("^(docs|fix|chore|style)"; "i")) |
          .number
        ')
        
        if [ -z "$ELIGIBLE_PRS" ]; then
          echo "âœ… Aucune PR Ã©ligible pour auto-merge"
          exit 0
        fi
        
        echo "ðŸ¤– PRs Ã©ligibles pour auto-merge:"
        for pr_num in $ELIGIBLE_PRS; do
          PR_TITLE=$(gh pr view $pr_num --json title --jq .title)
          echo "  - PR #$pr_num: $PR_TITLE"
          
          # Activer auto-merge avec squash
          gh pr merge $pr_num --auto --squash
          
          # Ajouter un commentaire
          gh pr comment $pr_num --body "ðŸ¤– Auto-merge activÃ© pour cette PR car elle rÃ©pond aux critÃ¨res:
- âœ… PR ready (non-draft)
- âœ… Mergeable sans conflits  
- âœ… Petite taille (< 10 fichiers)
- âœ… Type de changement Ã©ligible

La PR sera automatiquement mergÃ©e dÃ¨s que les checks passeront."
          
          echo "ðŸ¤– Auto-merge activÃ©: PR #$pr_num"
        done